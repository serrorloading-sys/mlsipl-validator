<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLSIPL Validator v73 (Calculation Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; min-height: 100vh; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* Table Controls */
        .table-container { overflow: auto; max-height: 600px; position: relative; }
        th { position: sticky; top: 0; background-color: #e2e8f0; z-index: 20; font-size: 11px; border-right: 1px solid #cbd5e1; user-select: none; }
        th:hover { background-color: #d1d5db; }
        
        /* Resizable Headers */
        .th-content { display: flex; align-items: center; justify-content: space-between; padding: 12px; cursor: pointer; height: 100%; width: 100%; }
        .resizer { width: 5px; cursor: col-resize; height: 100%; position: absolute; right: 0; top: 0; bottom: 0; }
        .resizer:hover { background: #94a3b8; }

        td { font-size: 11px; vertical-align: middle; border-bottom: 1px solid #e2e8f0; }
        
        .badge-ok { color: #166534; background: #dcfce7; padding: 2px 8px; border-radius: 12px; font-weight: 800; border: 1px solid #86efac; }
        .badge-warn { color: #854d0e; background: #fef9c3; padding: 2px 8px; border-radius: 12px; font-weight: 800; border: 1px solid #fde047; }
        .badge-err { color: #991b1b; background: #fee2e2; padding: 2px 8px; border-radius: 12px; font-weight: 800; border: 1px solid #fca5a5; }
        
        .tab-btn { padding: 10px 20px; font-weight: bold; color: #64748b; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.2s; }
        .tab-btn:hover { background: #f1f5f9; }
        .tab-btn.active { color: #2563eb; border-bottom: 3px solid #2563eb; background: #eff6ff; }
    </style>
</head>
<body class="p-4 text-gray-800">

    <div class="max-w-[99%] mx-auto pb-20 fade-in">
        
        <div class="bg-white border-l-8 border-indigo-600 rounded shadow-sm px-6 py-4 flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-indigo-900"><i class="fas fa-calculator mr-2"></i>MLSIPL Validator <span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded ml-2">v73</span></h1>
                <p class="text-xs text-gray-500 mt-1">Calculation Logic Fixed: Damage Priority > Date Priority</p>
            </div>
            <div class="flex gap-2 items-center">
                <div id="statusIndicator" class="mr-4 text-xs font-bold text-gray-400"><i class="fas fa-circle text-[8px]"></i> Loading...</div>
                <button onclick="openConfig()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm font-bold shadow transition"><i class="fas fa-database mr-1"></i> Master Config</button>
                <button onclick="location.reload()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded text-sm font-bold hover:bg-gray-300"><i class="fas fa-redo"></i></button>
            </div>
        </div>

        <div class="bg-gray-800 text-white p-4 rounded shadow mb-6 border-l-4 border-yellow-400">
            <h3 class="text-sm font-bold text-yellow-400 mb-2"><i class="fas fa-user-md mr-2"></i>Scanner Doctor</h3>
            <div class="flex gap-4 items-center mb-3">
                <input type="text" id="testInput" placeholder="Paste scan string here..." class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm text-white font-mono focus:outline-none focus:border-yellow-400">
                <button onclick="runDoctor()" class="bg-yellow-500 hover:bg-yellow-600 text-black px-4 py-2 rounded text-sm font-bold">Diagnose</button>
            </div>
            <div id="doctorRes" class="text-xs font-mono hidden grid grid-cols-6 gap-2 bg-gray-900 p-2 rounded"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-5 rounded shadow border-t-4 border-blue-500 relative">
                <label class="font-bold text-blue-900 text-sm mb-2 block">1. Scan File (Excel)</label>
                <input type="file" id="fileScan" class="w-full text-xs mb-2"/>
                <div class="flex justify-between items-center text-[10px] text-gray-500 mt-2 bg-blue-50 p-2 rounded">
                    <div class="grid grid-cols-2 gap-2">
                        <span>String Col (A=0): <input type="number" id="colScan" value="0" class="w-8 border text-center font-bold"></span>
                        <span>Cond Col (B=1): <input type="number" id="colCond" value="1" class="w-8 border text-center font-bold"></span>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="chkScanHeader" class="mr-1" checked> <label for="chkScanHeader" class="font-bold cursor-pointer">Has Header?</label>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded shadow border-t-4 border-green-500 relative">
                <label class="font-bold text-green-900 text-sm mb-2 block">2. System Stock (Excel)</label>
                <input type="file" id="fileSys" class="w-full text-xs mb-2"/>
                <div class="text-[10px] text-gray-500 mt-2 bg-green-50 p-2 rounded">
                    <div class="mb-1"><b>Fields:</b> Mat, Batch, Qty (Flexible), Plant, Customer</div>
                    <div class="flex gap-2 border-t border-green-200 pt-1">
                        <span>Ovr Cust Col: <input type="number" id="colCustOverride" placeholder="Auto" class="w-8 border text-center font-bold"></span>
                        <span>Ovr Plant Col: <input type="number" id="colPlantOverride" placeholder="Auto" class="w-8 border text-center font-bold"></span>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="runMLSIPL()" id="btnRun" class="w-full bg-indigo-700 hover:bg-indigo-800 text-white py-3 rounded shadow-lg font-bold text-lg mb-8 transition transform active:scale-[0.99]">
            START RECONCILIATION
        </button>

        <div id="dashboard" class="hidden space-y-6">
            
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                <div class="bg-white p-3 rounded shadow border-l-4 border-blue-600">
                    <div class="text-[9px] text-gray-500 font-bold uppercase">Total System Stock</div>
                    <div class="text-xl font-bold text-gray-800" id="k-sap">0</div>
                </div>
                <div class="bg-white p-3 rounded shadow border-l-4 border-gray-500">
                    <div class="text-[9px] text-gray-500 font-bold uppercase">Total Scanned</div>
                    <div class="text-xl font-bold text-gray-800" id="k-scan">0</div>
                </div>
                <div class="bg-white p-3 rounded shadow border-l-4 border-green-600">
                    <div class="text-[9px] text-green-600 font-bold uppercase">Matched (Consumed)</div>
                    <div class="text-xl font-bold text-green-700" id="k-match">0</div>
                </div>
                <div class="bg-white p-3 rounded shadow border-l-4 border-yellow-500">
                    <div class="text-[9px] text-yellow-600 font-bold uppercase">Batch Mismatch</div>
                    <div class="text-xl font-bold text-yellow-700" id="k-swap">0</div>
                </div>
                <div class="bg-white p-3 rounded shadow border-l-4 border-purple-600">
                    <div class="text-[9px] text-purple-600 font-bold uppercase">Remaining Stock</div>
                    <div class="text-xl font-bold text-purple-700" id="k-remain">0</div>
                </div>
                
                <div class="bg-white p-3 rounded shadow border-l-4 border-green-400">
                    <div class="text-[9px] text-green-600 font-bold uppercase">Good Cond</div>
                    <div class="text-xl font-bold text-green-600" id="k-good">0</div>
                </div>
                <div class="bg-white p-3 rounded shadow border-l-4 border-red-400">
                    <div class="text-[9px] text-red-600 font-bold uppercase">Damage</div>
                    <div class="text-xl font-bold text-red-600" id="k-dmg">0</div>
                </div>
                <div class="bg-white p-3 rounded shadow border-l-4 border-orange-400">
                    <div class="text-[9px] text-orange-600 font-bold uppercase">Expiry/Near</div>
                    <div class="text-xl font-bold text-orange-600" id="k-exp">0</div>
                </div>
                <div class="bg-white p-3 rounded shadow border-l-4 border-red-700 col-span-2">
                    <div class="text-[9px] text-red-800 font-bold uppercase">Variance</div>
                    <div class="text-xl font-bold text-red-800" id="k-var">0</div>
                </div>
            </div>

            <div class="bg-white p-3 rounded shadow flex justify-between items-center">
                <div class="relative w-full md:w-1/3">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="searchBox" onkeyup="filterTable()" placeholder="Search Material, Batch, Plant..." class="w-full border rounded pl-10 pr-4 py-2 text-sm focus:outline-none focus:border-indigo-500">
                </div>
                <button onclick="exportData()" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700 text-sm"><i class="fas fa-file-excel mr-2"></i> Export</button>
            </div>

            <div class="bg-white rounded shadow overflow-hidden border">
                <div class="table-container">
                    <table class="w-full text-left" id="mainTable">
                        <thead class="bg-gray-100 text-gray-700 font-bold uppercase text-[10px]">
                            <tr>
                                <th class="w-10 bg-gray-50 text-center">SN#</th>
                                <th class="w-20"><div class="th-content" onclick="sortTable(0)">Status <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th class="w-16"><div class="th-content" onclick="sortTable(1)">Cond <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th class="w-24 bg-gray-200"><div class="th-content" onclick="sortTable(2)">Plant <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th class="w-32"><div class="th-content" onclick="sortTable(3)">Raw Scan <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th class="text-blue-700"><div class="th-content" onclick="sortTable(4)">Scan Code <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th class="text-green-700"><div class="th-content" onclick="sortTable(5)">SAP Code <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th class="w-32"><div class="th-content" onclick="sortTable(6)">Desc <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th class="bg-blue-50"><div class="th-content" onclick="sortTable(7)">Phy Batch <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th class="bg-green-50"><div class="th-content" onclick="sortTable(8)">Sys Batch <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th><div class="th-content" onclick="sortTable(9)">Cust Code <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th><div class="th-content" onclick="sortTable(10)">Cust Name <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th><div class="th-content" onclick="sortTable(11)">Mfg <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th><div class="th-content" onclick="sortTable(12)">Exp <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                                <th><div class="th-content" onclick="sortTable(13)">Remarks <i class="fas fa-sort ml-1"></i></div><div class="resizer"></div></th>
                            </tr>
                        </thead>
                        <tbody id="resBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="configModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center backdrop-blur-sm">
            <div class="bg-white w-11/12 md:w-3/4 h-[90vh] rounded-lg shadow-2xl flex flex-col overflow-hidden">
                <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                    <h2 class="font-bold text-lg"><i class="fas fa-sliders-h mr-2"></i>Master Configuration</h2>
                    <button onclick="document.getElementById('configModal').classList.add('hidden')" class="hover:text-gray-300"><i class="fas fa-times text-xl"></i></button>
                </div>
                
                <div class="flex border-b bg-gray-50 overflow-x-auto">
                    <div class="tab-btn active" onclick="switchTab('tabMat')">1. Materials</div>
                    <div class="tab-btn" onclick="switchTab('tabCust')">2. Customers</div>
                    <div class="tab-btn" onclick="switchTab('tabRules')">3. Rules</div>
                    <div class="tab-btn" onclick="switchTab('tabAdv')">4. Logic & Qty</div>
                    <div class="tab-btn" onclick="switchTab('tabMsg')">5. Remarks</div>
                </div>
                
                <div class="flex-1 p-6 overflow-y-auto bg-white">
                    <div id="tabMat" class="tab-content h-full">
                        <label class="block text-sm font-bold mb-2 text-gray-700">ScanCode, SAPCode, Description (CSV)</label>
                        <textarea id="txtMaster" class="w-full h-full border p-3 text-xs font-mono bg-gray-50 rounded focus:outline-none focus:border-indigo-500"></textarea>
                    </div>
                    
                    <div id="tabCust" class="tab-content hidden h-full">
                        <label class="block text-sm font-bold mb-2 text-gray-700">CustomerCode, CustomerName (CSV)</label>
                        <textarea id="txtCust" class="w-full h-full border p-3 text-xs font-mono bg-gray-50 rounded focus:outline-none focus:border-indigo-500"></textarea>
                    </div>
                    
                    <div id="tabRules" class="tab-content hidden h-full">
                        <label class="block text-sm font-bold mb-2 text-gray-700">Parsing Rules (All Restored)</label>
                        <textarea id="txtRules" class="w-full h-full border p-3 text-xs font-mono bg-blue-50 rounded focus:outline-none focus:border-indigo-500">
# Short Codes
20,0,11,11,9,0,0,0,0
22,0,13,13,9,0,0,0,0

# GS1 Style Long Codes (All 20+ Lengths Included)
55,37,10,27,10,19,6,9,6
56,38,10,27,11,19,6,9,6
57,46,11,18,9,29,6,37,6
58,40,12,29,11,0,0,0,0
59,40,12,29,11,0,0,0,0
60,47,11,33,14,0,0,0,0
61,43,14,31,12,0,0,0,0
62,40,11,31,9,0,0,0,0
64,44,11,31,13,0,0,0,0
65,43,10,30,13,0,0,0,0
66,44,11,31,13,0,0,0,0
67,45,12,32,13,0,0,0,0
68,46,13,33,13,0,0,0,0
69,46,10,32,14,0,0,0,0
70,47,11,33,14,0,0,0,0
71,48,11,33,15,0,0,0,0
</textarea>
                    </div>

                    <div id="tabAdv" class="tab-content hidden h-full space-y-6">
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">Expiry Logic Settings</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-500">Near Expiry (Months)</label>
                                    <input type="number" id="txtNearExp" class="w-full border p-2 text-sm rounded" value="6">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">Short Expiry (Months)</label>
                                    <input type="number" id="txtShortExp" class="w-full border p-2 text-sm rounded" value="3">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">Quantity Column Headers (Keywords)</label>
                            <div class="text-[10px] text-gray-500 mb-1">Tool will look for these words to find Qty column (comma separated)</div>
                            <input type="text" id="txtQtyKeys" class="w-full border p-2 text-sm rounded bg-gray-50" value="qty, quantity, unrestricted, stock, count, menge">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">Plant Consumption Priority</label>
                            <div class="text-[10px] text-gray-500 mb-1">Order of plants to consume stock from (e.g., 1001, 2002). If empty, auto-selects.</div>
                            <input type="text" id="txtPlantPrio" class="w-full border p-2 text-sm rounded bg-gray-50" placeholder="P101, P102, P103">
                        </div>
                    </div>
                    
                    <div id="tabMsg" class="tab-content hidden h-full">
                        <label class="block text-sm font-bold mb-2 text-gray-700">Custom Remarks</label>
                        <textarea id="txtMsg" class="w-full h-full border p-3 text-xs font-mono bg-gray-50 rounded focus:outline-none focus:border-indigo-500"></textarea>
                    </div>
                </div>
                
                <div class="p-4 border-t text-right bg-gray-100 flex justify-end gap-3">
                    <button onclick="document.getElementById('configModal').classList.add('hidden')" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-200 rounded">Cancel</button>
                    <button onclick="saveConfig()" class="bg-indigo-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-indigo-700">Save Everything</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DATA STORE ---
        let masterMap = {}, custMap = {}, parseRules = {}, msgMap = {};
        let configAdv = { qtyKeys:[], plantPrio:[], nearExp:6, shortExp:3 };
        let results = [];

        // --- TABS ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
        function openConfig() { document.getElementById('configModal').classList.remove('hidden'); }

        // --- CONFIG MANAGEMENT ---
        function loadConfig() {
            const m = localStorage.getItem('mlsipl_master_v72');
            const c = localStorage.getItem('mlsipl_cust_v72');
            const r = localStorage.getItem('mlsipl_rules_v72');
            const msg = localStorage.getItem('mlsipl_msg_v72');
            const adv = localStorage.getItem('mlsipl_adv_v72');

            if(m) {
                document.getElementById('txtMaster').value = m;
                masterMap = {};
                m.split('\n').forEach(l => { let p=l.split(','); if(p.length>=2) masterMap[p[0].trim().toUpperCase()] = {sap:p[1].trim(), desc:p[2]||''}; });
            }
            if(c) {
                document.getElementById('txtCust').value = c;
                custMap = {};
                c.split('\n').forEach(l => { let p=l.split(','); if(p.length>=2) custMap[p[0].trim().toUpperCase()] = p[1].trim(); });
            }
            if(r) document.getElementById('txtRules').value = r; 
            if(msg) document.getElementById('txtMsg').value = msg;
            
            // Advanced
            if(adv) {
                let parsed = JSON.parse(adv);
                document.getElementById('txtQtyKeys').value = parsed.qtyKeys.join(', ');
                document.getElementById('txtPlantPrio').value = parsed.plantPrio.join(', ');
                document.getElementById('txtNearExp').value = parsed.nearExp || 6;
                document.getElementById('txtShortExp').value = parsed.shortExp || 3;
                configAdv = parsed;
            } else {
                configAdv.qtyKeys = ['qty','quantity','unrestricted','stock','count'];
            }

            // Rules Processing
            parseRules = {};
            (document.getElementById('txtRules').value || "").split('\n').forEach(l => {
                if(l.startsWith('#')||l.trim()==='') return;
                let p = l.split(',').map(x=>parseInt(x.trim()));
                if(p.length>=5) {
                    if(!parseRules[p[0]]) parseRules[p[0]]=[];
                    parseRules[p[0]].push({mS:p[1], mL:p[2], bS:p[3], bL:p[4], mgS:p[5]||0, mgL:p[6]||0, exS:p[7]||0, exL:p[8]||0});
                }
            });

            // Msg Processing
            msgMap = { 'Matched':'Matched', 'Batch Mismatch':'Batch Mismatch', 'Variance':'Variance', 'Stock Exhausted':'Stock Exhausted', 'Master Missing':'Master Missing' }; 
            const rawMsg = document.getElementById('txtMsg').value || "Matched:OK\nBatch Mismatch:Partial\nVariance:Not Found";
            document.getElementById('txtMsg').value = rawMsg;
            rawMsg.split('\n').forEach(l => {
                let p = l.split(':');
                if(p.length===2) msgMap[p[0].trim()] = p[1].trim();
            });

            document.getElementById('statusIndicator').innerHTML = `<i class="fas fa-check-circle text-green-500 text-[10px]"></i> Ready`;
        }

        function saveConfig() {
            localStorage.setItem('mlsipl_master_v72', document.getElementById('txtMaster').value);
            localStorage.setItem('mlsipl_cust_v72', document.getElementById('txtCust').value);
            localStorage.setItem('mlsipl_rules_v72', document.getElementById('txtRules').value);
            localStorage.setItem('mlsipl_msg_v72', document.getElementById('txtMsg').value);
            
            let advObj = {
                qtyKeys: document.getElementById('txtQtyKeys').value.split(',').map(s=>s.trim().toLowerCase()),
                plantPrio: document.getElementById('txtPlantPrio').value.split(',').map(s=>s.trim().toUpperCase()),
                nearExp: parseInt(document.getElementById('txtNearExp').value) || 6,
                shortExp: parseInt(document.getElementById('txtShortExp').value) || 3
            };
            localStorage.setItem('mlsipl_adv_v72', JSON.stringify(advObj));
            
            loadConfig();
            document.getElementById('configModal').classList.add('hidden');
            alert("Settings Saved!");
        }
        window.onload = loadConfig;

        // --- RESIZE HANDLER ---
        document.addEventListener('DOMContentLoaded', () => {
            const resizers = document.querySelectorAll('.resizer');
            resizers.forEach(r => r.addEventListener('mousedown', initResize));
        });
        
        let startX, startWidth, resizableCol;
        function initResize(e) {
            e.stopPropagation();
            resizableCol = e.target.parentElement;
            startX = e.pageX;
            startWidth = resizableCol.offsetWidth;
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        }
        function doResize(e) { resizableCol.style.width = (startWidth + e.pageX - startX) + 'px'; }
        function stopResize() { document.removeEventListener('mousemove', doResize); document.removeEventListener('mouseup', stopResize); }

        // --- UTILS ---
        function formatDate(s) { if(!s || s.length!=6) return "-"; return `20${s.substring(0,2)}-${s.substring(2,4)}-${s.substring(4,6)}`; }

        // --- PARSER ---
        function parseBarcode(raw) {
            let s = String(raw).trim().replace(/[\[\]\{\}【】（）]/g, m => (m==='['||m==='{'||m==='【'||m==='（')?'(':')');
            let len = s.length;
            let res = { scanCode:"", batch:"", sapCode:"Unknown", desc:"-", mfg:"-", exp:"-" };

            const gs1 = s.match(/^01(\d{14})10(.+?)11(\d{6})17(\d{6})240(.+)$/);
            if(gs1) { res.batch=gs1[2].trim(); res.mfg=gs1[3]; res.exp=gs1[4]; res.scanCode=gs1[5].trim(); }
            else if(s.includes('(')) {
                let m=s.match(/\(240\)([^()]+)/)||s.match(/\(21\)([^()]+)/); if(m) res.scanCode=m[1].trim();
                m=s.match(/\(10\)([^()]+)/); if(m) res.batch=m[1].trim();
                m=s.match(/\(11\)([^()]+)/); if(m) res.mfg=m[1];
                m=s.match(/\(17\)([^()]+)/); if(m) res.exp=m[1];
                if(!res.scanCode) res.scanCode=s;
            }
            else if(parseRules[len]) {
                let rule = parseRules[len][0];
                for(let r of parseRules[len]) { if(masterMap[s.substring(r.mS, r.mS+r.mL).trim().toUpperCase()]) { rule=r; break; } }
                res.scanCode=s.substring(rule.mS, rule.mS+rule.mL);
                res.batch=s.substring(rule.bS, rule.bS+rule.bL);
                if(rule.mgL) res.mfg=s.substring(rule.mgS, rule.mgS+rule.mgL);
                if(rule.exL) res.exp=s.substring(rule.exS, rule.exS+rule.exL);
            } else { res.scanCode=s; res.batch="Unknown"; }

            res.scanCode = res.scanCode.trim();
            res.batch = res.batch.trim().replace(/[^a-zA-Z0-9-]/g,'');
            let k = res.scanCode.toUpperCase();
            if(masterMap[k]) { res.sapCode=masterMap[k].sap; res.desc=masterMap[k].desc; }
            else res.sapCode="Not in Master";
            res.mfg = formatDate(res.mfg); res.exp = formatDate(res.exp);
            return res;
        }

        // --- PROCESS ---
        const readXlsx = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(e.target.result), {type:'array'}).Sheets[XLSX.read(new Uint8Array(e.target.result), {type:'array'}).SheetNames[0]], {header:1, defval:""}));
            reader.readAsArrayBuffer(file);
        });

        async function runMLSIPL() {
            const fScan = document.getElementById('fileScan').files[0];
            const fSys = document.getElementById('fileSys').files[0];
            const cScan = parseInt(document.getElementById('colScan').value);
            const cCond = parseInt(document.getElementById('colCond').value);
            const hasHead = document.getElementById('chkScanHeader').checked;
            
            if(!fScan || !fSys) { alert("Upload both files"); return; }
            document.getElementById('btnRun').innerText = "PROCESSING...";

            try {
                const rawSys = await readXlsx(fSys);
                const h = rawSys[0].map(x=>String(x).toLowerCase());
                
                const iMat = h.findIndex(x=>x.includes('material')||x.includes('item'));
                const iBatch = h.findIndex(x=>x.includes('batch')||x.includes('lot'));
                
                let iQty = -1;
                for(let k of configAdv.qtyKeys) { iQty = h.findIndex(x=>x.includes(k)); if(iQty>-1) break; }
                
                const ovrCust = document.getElementById('colCustOverride').value;
                const ovrPlant = document.getElementById('colPlantOverride').value;
                let iCust = ovrCust ? parseInt(ovrCust) : h.findIndex(x=>x.includes('customer')||x.includes('cust'));
                let iName = h.findIndex(x=>x.includes('name 1')||x.includes('name'));
                let iPlant = ovrPlant ? parseInt(ovrPlant) : h.findIndex(x=>x.includes('plant')||x.includes('site')||x.includes('wrks'));

                if(iMat<0 || iQty<0) throw new Error("System file needs Material & Qty (Check Config Keywords)");

                let inv = [];
                for(let i=1; i<rawSys.length; i++) {
                    let r = rawSys[i];
                    if(!r[iMat]) continue;
                    let q = parseFloat(r[iQty])||0;
                    let cCode = iCust>-1 && r[iCust] ? String(r[iCust]).trim() : "-";
                    let cName = iName>-1 && r[iName] ? String(r[iName]).trim() : "-";
                    let pl = iPlant>-1 && r[iPlant] ? String(r[iPlant]).trim().toUpperCase() : "-";
                    
                    for(let k=0; k<q; k++) inv.push({ mat:String(r[iMat]).trim().toUpperCase(), batch:iBatch>-1?String(r[iBatch]).trim().toUpperCase():"NA", cust:cCode, name:cName, plant:pl, used:false });
                }

                const rawScan = await readXlsx(fScan);
                results = [];
                let stats = { sap: inv.length, match:0, var:0, scan:0, swap:0, good:0, dmg:0, exp:0 };
                let startRow = hasHead ? 1 : 0;
                let today = new Date();

                for(let i=startRow; i<rawScan.length; i++) {
                    let r = rawScan[i];
                    let rawStr = r[cScan];
                    if(!rawStr) continue;
                    stats.scan++;
                    
                    let p = parseBarcode(rawStr);
                    let condRaw = r[cCond] ? String(r[cCond]).trim().toLowerCase() : "good";
                    let cond = "Good";
                    
                    // FIXED LOGIC: Damage Priority > Expiry Priority
                    if(condRaw.includes('dam') || condRaw.includes('bad') || condRaw.includes('broken')) { 
                        cond = "Damage"; 
                        stats.dmg++; 
                    } 
                    else if(p.exp !== "-" && p.exp.length === 10) {
                        let expDate = new Date(p.exp);
                        if(expDate < today) { cond="Expired"; stats.exp++; }
                        else {
                            let diffMonths = (expDate - today) / (1000 * 60 * 60 * 24 * 30.44);
                            if(diffMonths < configAdv.shortExp) { cond="Short Exp"; stats.exp++; }
                            else if(diffMonths < configAdv.nearExp) { cond="Near Exp"; stats.exp++; }
                            else { stats.good++; }
                        }
                    } 
                    else { 
                        stats.good++; 
                    }

                    let status="Variance", sysBatch="-", sysPlant="-", custCode="-", custName="-", rem=msgMap['Variance'], badge="badge-err";

                    if(p.sapCode !== "Not in Master") {
                        let candidates = inv.filter(x => !x.used && x.mat === p.sapCode);
                        candidates.sort((a,b) => {
                            let aBatch = (a.batch === p.batch) ? 1 : 0;
                            let bBatch = (b.batch === p.batch) ? 1 : 0;
                            if (aBatch !== bBatch) return bBatch - aBatch;
                            let pA = configAdv.plantPrio.indexOf(a.plant);
                            let pB = configAdv.plantPrio.indexOf(b.plant);
                            if(pA === -1) pA = 999;
                            if(pB === -1) pB = 999;
                            return pA - pB;
                        });

                        let match = candidates[0];

                        if(match) {
                            match.used = true;
                            sysBatch = match.batch;
                            sysPlant = match.plant;
                            if(custMap[match.cust.toUpperCase()]) custName = custMap[match.cust.toUpperCase()];
                            else custName = match.name;
                            custCode = match.cust;

                            if(match.batch === p.batch) {
                                status = "Matched"; rem = msgMap['Matched']; badge="badge-ok"; stats.match++;
                            } else {
                                status = "Batch Mismatch"; rem = msgMap['Batch Mismatch']; badge="badge-warn"; stats.swap++;
                            }
                        } else {
                            let exists = inv.some(x => x.mat === p.sapCode);
                            rem = exists ? msgMap['Stock Exhausted'] : msgMap['Variance'];
                            stats.var++;
                        }
                    } else { stats.var++; rem = msgMap['Master Missing']; }

                    results.push({ status, badge, cond, raw:rawStr, p, sysBatch, sysPlant, custCode, custName, rem });
                }

                renderTable();
                updateKPIs(stats);
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('btnRun').innerText = "START RECONCILIATION";

            } catch(e) { alert(e.message); document.getElementById('btnRun').innerText = "Retry"; }
        }

        function updateKPIs(s) {
            document.getElementById('k-sap').innerText = s.sap;
            document.getElementById('k-scan').innerText = s.scan;
            document.getElementById('k-match').innerText = s.match;
            document.getElementById('k-swap').innerText = s.swap;
            document.getElementById('k-var').innerText = s.var;
            document.getElementById('k-remain').innerText = s.sap - (s.match + s.swap);
            document.getElementById('k-good').innerText = s.good;
            document.getElementById('k-dmg').innerText = s.dmg;
            document.getElementById('k-exp').innerText = s.exp;
        }

        function filterTable() {
            const term = document.getElementById('searchBox').value.toLowerCase();
            const rows = document.getElementById('resBody').getElementsByTagName('tr');
            for(let row of rows) row.style.display = row.textContent.toLowerCase().includes(term) ? "" : "none";
        }

        function renderTable() {
            document.getElementById('resBody').innerHTML = results.map((r, i) => `
                <tr class="hover:bg-blue-50 border-b">
                    <td class="p-2 font-bold text-gray-500 text-center text-[10px] border-r">${i + 1}</td>
                    <td class="p-2"><span class="${r.badge}">${r.status}</span></td>
                    <td class="p-2 text-xs font-bold ${r.cond.includes('Exp')||r.cond==='Damage'?'text-red-600':''}">${r.cond}</td>
                    <td class="p-2 text-xs font-mono bg-gray-100">${r.sysPlant}</td>
                    <td class="p-2 font-mono text-[10px] text-gray-500 truncate max-w-[100px]">${r.raw}</td>
                    <td class="p-2 font-bold text-blue-700 text-xs">${r.p.scanCode}</td>
                    <td class="p-2 font-bold text-green-700 text-xs">${r.p.sapCode}</td>
                    <td class="p-2 text-[10px] truncate max-w-[100px]">${r.p.desc}</td>
                    <td class="p-2 font-mono text-xs bg-blue-50">${r.p.batch}</td>
                    <td class="p-2 font-mono text-xs bg-green-50">${r.sysBatch}</td>
                    <td class="p-2 text-[10px] font-mono">${r.custCode}</td>
                    <td class="p-2 text-[10px] truncate max-w-[100px]">${r.custName}</td>
                    <td class="p-2 text-[10px]">${r.p.mfg}</td>
                    <td class="p-2 text-[10px]">${r.p.exp}</td>
                    <td class="p-2 text-[10px] italic">${r.rem}</td>
                </tr>
            `).join('');
        }

        let sortDir = true;
        function sortTable(n) {
            sortDir = !sortDir;
            results.sort((a,b) => {
                let vA = getKeyVal(a,n), vB = getKeyVal(b,n);
                return (vA < vB ? -1 : 1) * (sortDir ? 1 : -1);
            });
            renderTable();
        }
        function getKeyVal(r,n) {
            if(n===0) return r.status; if(n===1) return r.cond; if(n===2) return r.sysPlant;
            if(n===4) return r.p.scanCode; if(n===5) return r.p.sapCode; 
            if(n===6) return r.p.desc; if(n===7) return r.p.batch; 
            if(n===9) return r.custCode; if(n===10) return r.custName; return ""; 
        }

        function exportData() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(results.map((r, i)=>({
                SN: i+1, Status: r.status, Condition: r.cond, Plant: r.sysPlant,
                Raw: r.raw, ScanCode: r.p.scanCode, SAPCode: r.p.sapCode, Desc: r.p.desc,
                PhyBatch: r.p.batch, SysBatch: r.sysBatch, 
                CustCode: r.custCode, CustName: r.custName, Remarks: r.rem, Mfg: r.p.mfg, Exp: r.p.exp
            })));
            XLSX.utils.book_append_sheet(wb, ws, "Recon_Result");
            XLSX.writeFile(wb, "MLSIPL_Report_Final.xlsx");
        }
        function runDoctor() {
            const v = document.getElementById('testInput').value;
            if(!v) return;
            const p = parseBarcode(v);
            document.getElementById('doctorRes').innerHTML = `
                <div>LEN: ${v.length}</div><div>SCAN: ${p.scanCode}</div><div>BATCH: ${p.batch}</div>
                <div>SAP: ${p.sapCode}</div><div>MFG: ${p.mfg}</div><div>EXP: ${p.exp}</div>
            `;
            document.getElementById('doctorRes').classList.remove('hidden');
        }
    </script>
</body>
</html>
